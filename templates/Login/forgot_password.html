{% extends 'base.html' %}

{% block title %}Forgot Password | uni.sa{% endblock %}

{% block head_extras %} 
<link rel="stylesheet" href="{{ url_for('static', filename='css/forgot_password.css') }}">
{% endblock %}

{% block content %}
<main class="main auth-page">
  <div class="form-container">
    <div class="container">
      <h1>Forgot Password</h1>
      <form action="{{ url_for('auth.forgot_password') }}" method="POST" id="forgotPasswordForm">
        <div class="form-group">
          <label for="userIdentifier">Email or Phone Number</label>
          <input 
            type="text" 
            id="userIdentifier" 
            name="userIdentifier" 
            class="form-input" 
            placeholder="Enter your email or phone" 
            required 
          />
          <div class="validation-message" id="validationMessage" style="color: #ef4444; font-size: 0.875rem; margin-top: 0.5rem; display: none;"></div>
        </div>
        <div class="form-group" style="text-align: center; margin-top: 1rem;">
          <button type="submit" class="button" style="width: 150px;" id="submitBtn">Send OTP</button>
        </div>
      </form>
      <div class="toggle-text" style="margin-top: 1rem;">
        <a href="{{ url_for('login') }}">Back to Login</a>
      </div>

      <script>
        document.addEventListener('DOMContentLoaded', function() {
          const form = document.getElementById('forgotPasswordForm');
          const input = document.getElementById('userIdentifier');
          const validationMessage = document.getElementById('validationMessage');
          const submitBtn = document.getElementById('submitBtn');

          function validateInput(value) {
            // Trim whitespace
            value = value.trim();
            if (!value) {
              validationMessage.textContent = 'Please enter your email or phone number';
              validationMessage.style.display = 'block';
              submitBtn.disabled = true;
              return false;
            }

            if (value.includes('@')) {
              // Email validation - RFC 5322 compliant
              const emailRegex = /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;
              if (!emailRegex.test(value) || value.length > 254) {
                validationMessage.textContent = 'Please enter a valid email address';
                validationMessage.style.display = 'block';
                submitBtn.disabled = true;
                return false;
              }
            } else {
              // Phone validation (10 digits, numbers only)
              const phoneRegex = /^\d{10}$/;
              value = value.replace(/\D/g, ''); // Remove non-digits
              if (!phoneRegex.test(value)) {
                validationMessage.textContent = 'Please enter a valid 10-digit phone number';
                validationMessage.style.display = 'block';
                submitBtn.disabled = true;
                return false;
              }
            }
            validationMessage.style.display = 'none';
            submitBtn.disabled = false;
            return true;
          }

          // Auto-format phone numbers as typed
          input.addEventListener('input', function(e) {
            let value = e.target.value.trim();
            
            // If it looks like a phone number (no @ and has numbers)
            if (!value.includes('@') && /\d/.test(value)) {
              // Keep only digits
              value = value.replace(/\D/g, '');
              // Limit to 10 digits
              value = value.substring(0, 10);
              // Update input with formatted value
              e.target.value = value;
            }
            
            validateInput(value);
          });

          // Validate on blur to catch pasted values
          input.addEventListener('blur', function(e) {
            validateInput(e.target.value);
          });

          form.addEventListener('submit', function(e) {
            const value = input.value.trim();
            if (!value || !validateInput(value)) {
              e.preventDefault();
              input.focus();
            }
          });

          {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
              {% for category, message in messages %}
                validationMessage.textContent = '{{ message }}';
                validationMessage.style.display = 'block';
                {% if category == 'error' %}
                  validationMessage.style.color = '#ef4444';
                {% else %}
                  validationMessage.style.color = '#10b981';
                {% endif %}
              {% endfor %}
            {% endif %}
          {% endwith %}
        });
      </script>
    </div>
  </div>
</main>
{% endblock %}
