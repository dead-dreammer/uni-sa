{% extends 'base.html' %} {% block title %}Dashboard | uni.sa{% endblock %} {%
block head_extras %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/start_search.css') }}"
/>
{% endblock %} {% block content %}
<main class="main-container">
  <!-- Header -->
  <div class="dashboard-header">
    <h1>Dashboard</h1>
    <p>Manage your university search and matched results</p>
  </div>

  <!-- Dashboard Grid -->
  <div class="dashboard-grid two-columns">
    <!-- Left Column -->
    <div class="left-column">
      <!-- Personal Info / DIT Container -->
      <section class="dashboard-section full-width personal-section">
        <div class="section-header">
          <h2>Personal Information and Preferences</h2>
          <span class="section-icon">üéì</span>
        </div>
        <p class="section-description">
          Update your profile details and preferences to receive better
          university matches
        </p>
        <a href="{{ url_for('personal_info') }}" class="btn btn-primary"
          >Edit
        </a>
      </section>

      <!-- Generated Reports -->
      <section class="dashboard-section scrollable">
        <div class="section-header">
          <h2>Generated Reports</h2>
          <span class="section-icon">üìä</span>
        </div>
        <div class="reports-content">
          <div id="reportsContainer">
            <p class="empty-state">
              No reports generated yet. Complete your profile to get started.
            </p>
          </div>
        </div>
      </section>

      <!-- Saved Universities -->
      <section class="dashboard-section scrollable">
        <div class="section-header">
          <h2>Saved Universities</h2>
          <span class="section-icon">‚ù§Ô∏è</span>
        </div>
        <div id="likesContainer" class="likes-container">
          <p class="empty-state">You haven't saved any universities yet.</p>
        </div>
      </section>
    </div>

    <!-- Right Column -->
    <div class="right-column scrollable">
      <section class="dashboard-section">
        <div class="section-header">
          <h2>Matched Universities</h2>
          <span class="section-icon">üéØ</span>
        </div>
        <div id="matchesContainer" class="matches-container">
          <p class="empty-state">
            No matches available yet. Complete your profile to discover
            universities.
          </p>
        </div>
        <div
          class="section-footer"
          style="margin-top: 1rem; text-align: center"
        >
          <a href="{{ url_for('courses.get_matches') }}" class="btn btn-primary"
            >View All Matches</a
          >
        </div>
      </section>
    </div>
  </div>
</main>

{% endblock %} {% block scripts %}
<script src="{{ url_for('static', filename='js/search.js') }}"></script>

<script>
  // Initialize data structure
  const userData = {
    reports: [],
    matches: [],
    likes: JSON.parse(localStorage.getItem("likedCourses") || "[]"),
  };

  // Fetch matches from the server
  async function fetchMatches() {
    try {
      const response = await fetch("/courses/debug_matches");
      const data = await response.json();
      if (data.matches) {
        userData.matches = data.matches.map((match) => ({
          id: match.program.program_id,
          name: match.university.name,
          province: match.university.province_state,
          programName: match.program.program_name,
          matchScore: match.match_score,
          ranking: match.match_score,
        }));
        renderMatches();
      }
    } catch (error) {
      console.error("Error fetching matches:", error);
    }
  }

  // Call fetchMatches when page loads
  fetchMatches();

  // Render Reports (uses download_url when available)
  function renderReports() {
    const container = document.getElementById("reportsContainer");
    if (!container) return;
    if (!userData.reports || userData.reports.length === 0) {
      container.innerHTML =
        '<p class="empty-state">No reports generated yet. Complete your profile to get started.</p>';
      return;
    }

    container.innerHTML = userData.reports
      .map((report) => {
        const downloadUrl =
          report.download_url || `/reports/${report.id}/download`;
        const displayDate = report.created_at
          ? new Date(report.created_at).toLocaleString()
          : report.date
          ? new Date(report.date).toLocaleString()
          : "";
        return `
        <div class="report-item">
          <div class="report-info">
            <h4>${escapeHtml(report.title || "Report")}</h4>
            <p class="report-date">${escapeHtml(displayDate)}</p>
          </div>
          <a href="${downloadUrl}" class="btn btn-small btn-secondary" target="_blank" rel="noopener">Download</a>
        </div>
      `;
      })
      .join("");
  }

  // Render Matched Universities
  function renderMatches() {
    const container = document.getElementById("matchesContainer");
    if (userData.matches.length === 0) {
      container.innerHTML =
        '<p class="empty-state">No matches available yet. Complete your profile to discover universities.</p>';
      return;
    }
    container.innerHTML = userData.matches
      .map((uni) => {
        const matchClass =
          uni.matchScore >= 90
            ? "strong-match"
            : uni.matchScore >= 70
            ? "good-match"
            : "moderate-match";
        const isLiked = userData.likes.some(
          (like) => like.id === String(uni.id)
        );

        return `
          <div class="match-item ${matchClass}">
            <div class="match-info">
              <h4>${uni.name}</h4>
              <p class="match-program">${uni.programName}</p>
              <p class="match-province">${uni.province}</p>
              <span class="match-score">Match Score: ${uni.matchScore}%</span>
            </div>
            <button class="btn btn-like ${isLiked ? "liked" : ""}" 
                    onclick="addToLikes('${uni.id}', '${uni.name} - ${
          uni.programName
        }', '${uni.province}')">
              <span class="heart">${isLiked ? "‚ô•" : "‚ô°"}</span>
            </button>
          </div>
        `;
      })
      .join("");
  }

  // Render Liked Universities
  function renderLikes() {
    const container = document.getElementById("likesContainer");
    if (userData.likes.length === 0) {
      container.innerHTML =
        '<p class="empty-state">You haven\'t saved any universities yet.</p>';
      return;
    }
    container.innerHTML = userData.likes
      .map(
        (uni, index) => `
        <div class="like-item">
          <div class="like-info">
            <h4>${uni.name}</h4>
            <p class="like-province">${uni.province}</p>
          </div>
          <button class="btn btn-remove" onclick="removeFromLikes(${index})">
            ‚úï
          </button>
        </div>
      `
      )
      .join("");
  }

  // Add to Likes
  function addToLikes(id, name, province) {
    const alreadyLiked = userData.likes.some((uni) => uni.id === id);
    if (!alreadyLiked) {
      userData.likes.push({
        id,
        name,
        province,
        timestamp: new Date().toISOString(),
      });
      localStorage.setItem("likedCourses", JSON.stringify(userData.likes));
    } else {
      userData.likes = userData.likes.filter((uni) => uni.id !== id);
      localStorage.setItem("likedCourses", JSON.stringify(userData.likes));
    }
    renderLikes();
    renderMatches();
  }

  // Remove from Likes
  function removeFromLikes(index) {
    userData.likes.splice(index, 1);
    renderLikes();
  }

  // Utility to escape HTML
  function escapeHtml(s) {
    if (!s) return "";
    return String(s)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#39;");
  }

  // Initialize reports/matches/likes rendering
  renderReports();
  renderMatches();
  renderLikes();

  // --- dashboard_reports.js logic inlined below ---

  // Fetch saved reports from API
  async function fetchSavedReports() {
    try {
      const res = await fetch("/api/reports", { credentials: "same-origin" });
      if (!res.ok) throw new Error("Failed to fetch reports");
      const data = await res.json();
      return data.reports || [];
    } catch (err) {
      console.error("Error fetching reports:", err);
      return [];
    }
  }

  // On load populate reports and listen for generated events
  (async function initDashboardReports() {
    // Fetch reports from server and render
    const reports = await fetchSavedReports();
    // Normalize returned reports: ensure download_url exists
    userData.reports = reports.map((r) => ({
      id: r.id || r.report_id,
      title: r.title,
      created_at: r.created_at,
      download_url:
        r.download_url || `/reports/${r.id || r.report_id}/download`,
    }));
    renderReports();

    // If a recently-generated report exists in localStorage (from matches page), show it immediately
    try {
      const raw = localStorage.getItem("latest_report");
      if (raw) {
        const rep = JSON.parse(raw);
        if (rep) {
          const download_url = `/reports/${rep.id}/download`;
          // Prepend the new report if it's not already present
          if (!userData.reports.some((r) => String(r.id) === String(rep.id))) {
            userData.reports.unshift({
              id: rep.id,
              title: rep.title,
              created_at: rep.created_at,
              download_url,
            });
            renderReports();
          }
        }
        localStorage.removeItem("latest_report");
      }
    } catch (err) {
      console.warn("Could not apply latest_report from localStorage", err);
    }

    // Listen for in-window report generation events
    window.addEventListener("report:generated", async (e) => {
      const rep = e.detail;
      if (!rep) return;
      // Refresh list from server to get authoritative data
      const list = await fetchSavedReports();
      userData.reports = list.map((r) => ({
        id: r.id || r.report_id,
        title: r.title,
        created_at: r.created_at,
        download_url:
          r.download_url || `/reports/${r.id || r.report_id}/download`,
      }));
      renderReports();
    });
  })();

  // Fetch saved reports from server and populate dashboard (legacy loader removed)
</script>
{% endblock %}
