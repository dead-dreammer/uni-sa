{% extends 'base.html' %}

{% block title %}Dashboard | uni.sa{% endblock %}

{% block head_extras %}
  <link
    rel="stylesheet"
    href="{{ url_for('static', filename='css/start_search.css') }}"
  />
{% endblock %}

{% block content %}
  <!-- Main Content -->
  <main class="main-container">
    <!-- Header -->
    <div class="dashboard-header">
      <h1>Dashboard</h1>
      <p>Manage your university search and matched results</p>
    </div>

    <!-- Dashboard Grid -->
    <div class="dashboard-grid">
      
      <!-- Personal Information Section -->
      <section class="dashboard-section personal-section">
        <div class="section-header">
          <h2>Personal Information and Preferences</h2>
          <span class="section-icon">üéì</span>
        </div>
        <p class="section-description">Update your profile details and preferences to receive better university matches</p>
        <a href="{{ url_for('personal_info') }}" class="btn btn-primary">Edit </a>
      </section>

      <!-- Reports Section -->
      <section class="dashboard-section reports-section">
        <div class="section-header">
          <h2>Generated Reports</h2>
          <span class="section-icon">üìä</span>
        </div>
        <div class="reports-content">
          <div id="reportsContainer">
            <p class="empty-state">No reports generated yet. Complete your profile to get started.</p>
          </div>
        </div>
      </section>

      <!-- Matched Universities Section -->
      <section class="dashboard-section matches-section">
        <div class="section-header">
          <h2>Matched Universities</h2>
          <span class="section-icon">üéØ</span>
        </div>
        <div id="matchesContainer" class="matches-container">
          <p class="empty-state">No matches available yet. Complete your profile to discover universities.</p>
        </div>
      </section>

      <!-- Liked Universities Section -->
      <section class="dashboard-section likes-section">
        <div class="section-header">
          <h2>Saved Universities</h2>
          <span class="section-icon">‚ù§Ô∏è</span>
        </div>
        <div id="likesContainer" class="likes-container">
          <p class="empty-state">You haven't saved any universities yet.</p>
        </div>
      </section>

    </div>
  </main>
{% endblock %}

{% block scripts %}
  <script src="{{ url_for('static', filename='js/search.js') }}"></script>

  <script>
    // Initialize data structure
    const userData = {
      reports: [],
      matches: [],
      likes: JSON.parse(localStorage.getItem('likedCourses') || '[]')
    };

    // Fetch matches from the server
    async function fetchMatches() {
      try {
        const response = await fetch('/courses/debug_matches');
        const data = await response.json();
        if (data.matches) {
          userData.matches = data.matches.map(match => ({
            id: match.program.program_id,
            name: match.university.name,
            province: match.university.province_state,
            programName: match.program.program_name,
            matchScore: match.match_score,
            ranking: match.match_score
          }));
          renderMatches();
        }
      } catch (error) {
        console.error('Error fetching matches:', error);
      }
    }

    // Call fetchMatches when page loads
    fetchMatches();

    // Render Reports
    function renderReports() {
      const container = document.getElementById('reportsContainer');
      if (userData.reports.length === 0) {
        container.innerHTML = '<p class="empty-state">No reports generated yet. Complete your profile to get started.</p>';
        return;
      }
      container.innerHTML = userData.reports.map(report => `
        <div class="report-item">
          <div class="report-info">
            <h4>${report.title}</h4>
            <p class="report-date">${report.date}</p>
          </div>
          <a href="#" class="btn btn-small btn-secondary">Download</a>
        </div>
      `).join('');
    }

    // Render Matched Universities
    function renderMatches() {
      const container = document.getElementById('matchesContainer');
      if (userData.matches.length === 0) {
        container.innerHTML = '<p class="empty-state">No matches available yet. Complete your profile to discover universities.</p>';
        return;
      }
      container.innerHTML = userData.matches.map(uni => {
        const matchClass = uni.matchScore >= 90 ? 'strong-match' : 
                         uni.matchScore >= 70 ? 'good-match' : 'moderate-match';
        const isLiked = userData.likes.some(like => like.id === String(uni.id));
        
        return `
          <div class="match-item ${matchClass}">
            <div class="match-info">
              <h4>${uni.name}</h4>
              <p class="match-program">${uni.programName}</p>
              <p class="match-province">${uni.province}</p>
              <span class="match-score">Match Score: ${uni.matchScore}%</span>
            </div>
            <button class="btn btn-like ${isLiked ? 'liked' : ''}" 
                    onclick="addToLikes('${uni.id}', '${uni.name} - ${uni.programName}', '${uni.province}')">
              <span class="heart">${isLiked ? '‚ô•' : '‚ô°'}</span>
            </button>
          </div>
        `;
      }).join('');
    }

    // Render Liked Universities
    function renderLikes() {
      const container = document.getElementById('likesContainer');
      if (userData.likes.length === 0) {
        container.innerHTML = '<p class="empty-state">You haven\'t saved any universities yet.</p>';
        return;
      }
      container.innerHTML = userData.likes.map((uni, index) => `
        <div class="like-item">
          <div class="like-info">
            <h4>${uni.name}</h4>
            <p class="like-province">${uni.province}</p>
          </div>
          <button class="btn btn-remove" onclick="removeFromLikes(${index})">
            ‚úï
          </button>
        </div>
      `).join('');
    }

    // Add to Likes
    function addToLikes(id, name, province) {
      const alreadyLiked = userData.likes.some(uni => uni.id === id);
      if (!alreadyLiked) {
        userData.likes.push({
          id,
          name,
          province,
          timestamp: new Date().toISOString()
        });
        localStorage.setItem('likedCourses', JSON.stringify(userData.likes));
      } else {
        userData.likes = userData.likes.filter(uni => uni.id !== id);
        localStorage.setItem('likedCourses', JSON.stringify(userData.likes));
      }
      renderLikes();
      renderMatches();
    }

    // Remove from Likes
    function removeFromLikes(index) {
      userData.likes.splice(index, 1);
      renderLikes();
    }

    // Initialize
    renderReports();
    renderMatches();
    renderLikes();
  </script>
{% endblock %}