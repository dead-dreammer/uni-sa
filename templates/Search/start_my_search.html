{% extends 'base.html' %}
{% block title %}Dashboard | uni.sa{% endblock %}
{% block head_extras %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/start_search.css') }}" />
{% endblock %}

{% block content %}
<main class="main-container">
  <!-- Header -->
  <div class="dashboard-header">
    <h1>Dashboard</h1>
    <p>Manage your university search and matched results</p>
  </div>

  <!-- Dashboard Grid -->
  <div class="dashboard-grid two-columns">
    <!-- Left Column -->
    <div class="left-column">
      <!-- Personal Info / DIT Container -->
      <section class="dashboard-section full-width personal-section">
        <div class="section-header">
          <h2>Personal Information and Preferences</h2>
          <span class="section-icon">üéì</span>
        </div>
        <p class="section-description">
          Update your profile details and preferences to receive better university matches
        </p>
        <a href="{{ url_for('personal_info') }}" class="btn btn-primary">Edit</a>
      </section>

      <!-- Generated Reports -->
      <section class="dashboard-section scrollable">
        <div class="section-header">
          <h2>Generated Reports</h2>
          <span class="section-icon">üìä</span>
        </div>
        <div class="reports-content">
          <div id="reportsContainer">
            <p class="empty-state">
              No reports generated yet. Complete your profile to get started.
            </p>
          </div>
        </div>
      </section>

      <!-- Saved Universities -->
      <section class="dashboard-section scrollable">
        <div class="section-header">
          <h2>Saved Universities</h2>
          <span class="section-icon">‚ù§Ô∏è</span>
        </div>
        <div id="likesContainer" class="likes-container">
          <p class="empty-state">You haven't saved any universities yet.</p>
        </div>
      </section>
    </div>

    <!-- Right Column -->
    <div class="right-column scrollable">
      <section class="dashboard-section">
        <div class="section-header">
          <h2>Matched Universities</h2>
          <span class="section-icon">üéØ</span>
        </div>
        <div id="matchesContainer" class="matches-container">
          <p class="empty-state">
            No matches available yet. Complete your profile to discover universities.
          </p>
        </div>
        <div class="section-footer" style="margin-top: 1rem; text-align: center">
          <a href="#" id="viewAllMatchesBtn" class="btn btn-primary">View All Matches</a>
        </div>
      </section>
    </div>
  </div>
</main>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/search.js') }}"></script>

<script>
  const userData = {
    reports: [],
    matches: [],
    likes: [],
    profileComplete: false,
  };

  // Escape HTML safely
  function escapeHtml(s) {
    if (!s) return "";
    return String(s)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#39;");
  }

  // --- PROFILE COMPLETION CHECK ---
  async function checkProfileComplete() {
    try {
      const response = await fetch("/api/profile/status");
      const data = await response.json();
      userData.profileComplete = data.complete || false;
      updateViewAllButton();
    } catch (error) {
      console.error("Error checking profile status:", error);
      userData.profileComplete = userData.matches.length > 0;
      updateViewAllButton();
    }
  }

  function updateViewAllButton() {
    const btn = document.getElementById("viewAllMatchesBtn");
    if (!btn) return;
    if (!userData.profileComplete || userData.matches.length === 0) {
      btn.href = "{{ url_for('personal_info') }}";
      btn.textContent = "Complete Profile";
    } else {
      btn.href = "{{ url_for('courses.get_matches') }}";
      btn.textContent = "View All Matches";
    }
  }

  // --- SERVER SYNC HELPERS ---
  async function fetchServerLikes() {
    try {
      const res = await fetch("/courses/liked-courses", { credentials: "same-origin" });
      if (!res.ok) return null;
      const data = await res.json();
      if (Array.isArray(data)) {
        // Server now returns full course objects, not just IDs
        return data;
      }
      return null;
    } catch (e) {
      console.warn("Could not fetch server likes:", e);
      return null;
    }
  }

  async function persistLikeToServer(programId) {
    try {
      const res = await fetch("/courses/save_liked_course", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "same-origin",
        body: JSON.stringify({ program_id: programId }),
      });
      return res.ok;
    } catch (e) {
      console.warn("Could not persist like to server:", e);
      return false;
    }
  }

  async function removeLikeOnServer(programId) {
    try {
      const res = await fetch("/courses/remove_liked_course", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "same-origin",
        body: JSON.stringify({ program_id: programId }),
      });
      return res.ok;
    } catch (e) {
      console.warn("Could not remove like on server:", e);
      return false;
    }
  }

  // --- FETCH MATCHES ---
  async function fetchMatches() {
    try {
      const response = await fetch("/courses/debug_matches", { credentials: "same-origin" });
      const data = await response.json();
      if (data.matches) {
        userData.matches = data.matches.map((match) => ({
          id: match.program.program_id,
          name: match.university.name,
          province: match.university.province_state,
          programName: match.program.program_name,
          matchScore: match.match_score,
        }));
        userData.profileComplete = userData.matches.length > 0;
        renderMatches();
        updateViewAllButton();
      }
    } catch (error) {
      console.error("Error fetching matches:", error);
      updateViewAllButton();
    }
  }

  // --- RENDER SECTIONS ---
  function renderReports() {
    const container = document.getElementById("reportsContainer");
    if (!container) return;
    if (!userData.reports.length) {
      container.innerHTML = `<p class="empty-state">No reports generated yet. Complete your profile to get started.</p>`;
      return;
    }
    container.innerHTML = userData.reports
      .map(
        (r) => `
        <div class="report-item">
          <div class="report-info">
            <h4>${escapeHtml(r.title || "Report")}</h4>
            <p class="report-date">${escapeHtml(
              r.created_at ? new Date(r.created_at).toLocaleString() : ""
            )}</p>
          </div>
          <a href="${r.download_url || `/reports/${r.id}/download`}" class="btn btn-small btn-secondary" target="_blank" rel="noopener">Download</a>
        </div>
      `
      )
      .join("");
  }

  function renderMatches() {
    const container = document.getElementById("matchesContainer");
    if (userData.matches.length === 0) {
      container.innerHTML = `<p class="empty-state">No matches available yet. Complete your profile to discover universities.</p>`;
      return;
    }
    container.innerHTML = userData.matches
      .map((uni) => {
        const matchClass =
          uni.matchScore >= 90
            ? "strong-match"
            : uni.matchScore >= 70
            ? "good-match"
            : "moderate-match";
        const isLiked = userData.likes.some((l) => String(l.id) === String(uni.id));
        return `
          <div class="match-item ${matchClass}">
            <div class="match-info">
              <h4>${escapeHtml(uni.name)}</h4>
              <p class="match-program">${escapeHtml(uni.programName)}</p>
              <p class="match-province">${escapeHtml(uni.province)}</p>
              <span class="match-score">Match Score: ${uni.matchScore}%</span>
            </div>
            <button class="btn btn-like ${isLiked ? "liked" : ""}"
              onclick="addToLikes('${uni.id}', '${escapeHtml(uni.name)}', '${escapeHtml(uni.province)}', '${escapeHtml(uni.programName)}')">
              <span class="heart">${isLiked ? "‚ô•" : "‚ô°"}</span>
            </button>
          </div>`;
      })
      .join("");
  }

  function renderLikes() {
    const container = document.getElementById("likesContainer");
    if (userData.likes.length === 0) {
      container.innerHTML = `<p class="empty-state">You haven't saved any universities yet.</p>`;
      return;
    }
    container.innerHTML = userData.likes
      .map(
        (uni) => `
        <div class="like-item">
          <div class="like-info">
            <h4>${escapeHtml(uni.name || "Saved University")}</h4>
            ${uni.programName ? `<p class="like-program">${escapeHtml(uni.programName)}</p>` : ''}
            ${uni.province ? `<p class="like-province">${escapeHtml(uni.province)}</p>` : ''}
          </div>
          <button class="btn btn-remove" onclick="removeFromLikes('${uni.id}')">‚úï</button>
        </div>`
      )
      .join("");
  }

  // --- LIKE HANDLERS ---
  async function addToLikes(id, name, province, programName) {
    const alreadyLiked = userData.likes.some((uni) => String(uni.id) === String(id));
    if (!alreadyLiked) {
      // Add to likes
      const newLike = { 
        id, 
        name, 
        province, 
        programName: programName || '',
        timestamp: new Date().toISOString() 
      };
      userData.likes.push(newLike);
      localStorage.setItem("likedCourses", JSON.stringify(userData.likes));
      await persistLikeToServer(id);
      // Refresh from server to get complete data
      const serverLikes = await fetchServerLikes();
      if (serverLikes) {
        userData.likes = serverLikes;
        localStorage.setItem("likedCourses", JSON.stringify(serverLikes));
      }
    } else {
      // Remove from likes (toggle)
      userData.likes = userData.likes.filter((uni) => String(uni.id) !== String(id));
      localStorage.setItem("likedCourses", JSON.stringify(userData.likes));
      await removeLikeOnServer(id);
    }
    renderLikes();
    renderMatches(); // Re-render matches to update button states
  }

  async function removeFromLikes(id) {
    userData.likes = userData.likes.filter((l) => String(l.id) !== String(id));
    localStorage.setItem("likedCourses", JSON.stringify(userData.likes));
    await removeLikeOnServer(id);
    renderLikes();
    renderMatches(); // Re-render matches to update button states
  }

  // --- REPORT FETCHING ---
  async function fetchSavedReports() {
    try {
      const res = await fetch("/api/reports", { credentials: "same-origin" });
      if (!res.ok) return [];
      const data = await res.json();
      return data.reports || [];
    } catch (err) {
      console.error("Error fetching reports:", err);
      return [];
    }
  }

  // --- INITIALIZATION ---
  (async function initDashboard() {
    // Fetch likes FIRST before fetching matches so the liked state is available
    const serverLikes = await fetchServerLikes();
    if (serverLikes && serverLikes.length > 0) {
      userData.likes = serverLikes;
      localStorage.setItem("likedCourses", JSON.stringify(serverLikes));
    } else {
      // Fallback to localStorage if server fails
      const local = JSON.parse(localStorage.getItem("likedCourses") || "[]");
      userData.likes = Array.isArray(local) ? local : [];
    }
    
    // Now fetch matches - renderMatches() will have access to userData.likes
    await fetchMatches();
    
    const reports = await fetchSavedReports();
    userData.reports = reports.map((r) => ({
      id: r.id || r.report_id,
      title: r.title,
      created_at: r.created_at,
      download_url: r.download_url || `/reports/${r.id}/download`,
    }));
    
    renderReports();
    renderLikes();
    checkProfileComplete();
  })();
</script>
{% endblock %}
