{% extends 'base.html' %} {% block title %}Dashboard | uni.sa{% endblock %} {%
block head_extras %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/start_search.css') }}"
/>
{% endblock %} {% block content %}
<main class="main-container">
  <!-- Header -->
  <div class="dashboard-header">
    <h1>Dashboard</h1>
    <p>Manage your university search and matched results</p>
  </div>

  <!-- Dashboard Grid -->
  <div class="dashboard-grid two-columns">
    <!-- Left Column -->
    <div class="left-column">
      <!-- Personal Info / DIT Container -->
      <section class="dashboard-section full-width personal-section">
        <div class="section-header">
          <h2>Personal Information and Preferences</h2>
          <span class="section-icon">üéì</span>
        </div>
        <p class="section-description">
          Update your profile details and preferences to receive better
          university matches
        </p>
        <a href="{{ url_for('personal_info') }}" class="btn btn-primary"
          >Edit
        </a>
      </section>

      <!-- Generated Reports -->
      <section class="dashboard-section scrollable">
        <div class="section-header">
          <h2>Generated Reports</h2>
          <span class="section-icon">üìä</span>
        </div>
        <div class="reports-content">
          <div id="reportsContainer">
            <p class="empty-state">
              No reports generated yet. Complete your profile to get started.
            </p>
          </div>
        </div>
      </section>

      <!-- Saved Universities -->
      <section class="dashboard-section scrollable">
        <div class="section-header">
          <h2>Saved Universities</h2>
          <span class="section-icon">‚ù§Ô∏è</span>
        </div>
        <div id="likesContainer" class="likes-container">
          <p class="empty-state">You haven't saved any universities yet.</p>
        </div>
      </section>
    </div>

    <!-- Right Column -->
    <div class="right-column scrollable">
      <section class="dashboard-section">
        <div class="section-header">
          <h2>Matched Universities</h2>
          <span class="section-icon">üéØ</span>
        </div>
        <div id="matchesContainer" class="matches-container">
          <p class="empty-state">
            No matches available yet. Complete your profile to discover
            universities.
          </p>
        </div>
        <div
          class="section-footer"
          style="margin-top: 1rem; text-align: center"
        >
          <a href="{{ url_for('courses.get_matches') }}" class="btn btn-primary"
            >View All Matches</a
          >
        </div>
      </section>
    </div>
  </div>
</main>

{% endblock %} {% block scripts %}
<script src="{{ url_for('static', filename='js/search.js') }}"></script>

<script>
  // Initialize minimal data structure; likes will be populated from server when possible
  const userData = {
    reports: [],
    matches: [],
    likes: [],
  };

  // Utility: try to fetch server-side liked course ids; return array of ids or null on non-200
  async function fetchServerLikes() {
    try {
      const res = await fetch('/courses/liked-courses', { credentials: 'same-origin' });
      if (!res.ok) {
        // If unauthenticated or other error, don't treat as authoritative
        return null;
      }
      const data = await res.json();
      // Expecting an array of program_id numbers
      if (Array.isArray(data)) return data;
      return null;
    } catch (e) {
      console.warn('Could not fetch server likes:', e);
      return null;
    }
  }

  // Normalize server id list to the client like objects used here
  function mapIdsToLikes(ids) {
    return ids.map(id => {
      // Try to find matching program details from the already-fetched matches list
      const match = userData.matches.find(m => String(m.id) === String(id));
      if (match) {
        return { id: String(id), name: (match.name || '') + (match.programName ? ' - ' + match.programName : ''), province: match.province || '', timestamp: null };
      }
      // Fallback to a minimal object; UI will show 'Saved University' if name missing
      return { id: String(id), name: '', province: '', timestamp: null };
    });
  }

  // Fetch matches from the server
  async function fetchMatches() {
    try {
      const response = await fetch('/courses/debug_matches', { credentials: 'same-origin' });
      const data = await response.json();
      if (data.matches) {
        userData.matches = data.matches.map((match) => ({
          id: match.program.program_id,
          name: match.university.name,
          province: match.university.province_state,
          programName: match.program.program_name,
          matchScore: match.match_score,
          ranking: match.match_score,
        }));
        renderMatches();
      }
    } catch (error) {
      console.error('Error fetching matches:', error);
    }
  }

  // Call fetchMatches and load likes when page loads
  (async function initPage() {
    await fetchMatches();

    // Try to load server likes first; only accept if server returns OK and an array
    const serverIds = await fetchServerLikes();
    if (serverIds !== null) {
      userData.likes = mapIdsToLikes(serverIds);
      // persist a local copy to keep UI consistent between reloads
      try { localStorage.setItem('likedCourses', JSON.stringify(userData.likes)); } catch (e) {}
    } else {
      // Fallback to localStorage (only used when unauthenticated or server unavailable)
      try {
        const local = JSON.parse(localStorage.getItem('likedCourses') || '[]');
        // Normalize stored format if it was an array of ids or objects
        if (Array.isArray(local) && local.length && (typeof local[0] === 'string' || typeof local[0] === 'number')) {
          userData.likes = local.map(id => ({ id: String(id), name: '', province: '', timestamp: null }));
        } else if (Array.isArray(local)) {
          userData.likes = local.map(l => ({ id: String(l.id || l.program_id || l.id), name: l.name || '', province: l.province || '', timestamp: l.timestamp || null }));
        } else {
          userData.likes = [];
        }
      } catch (e) {
        userData.likes = [];
      }
    }

    renderReports();
    renderMatches();
    renderLikes();
  })();

  // Render Reports
  function renderReports() {
    const container = document.getElementById('reportsContainer');
    if (userData.reports.length === 0) {
      container.innerHTML = '<p class="empty-state">No reports generated yet. Complete your profile to get started.</p>';
      return;
    }
    // Render each saved report with a server download link so clicking re-downloads the persisted PDF
    container.innerHTML = userData.reports.map(report => `
        <div class="report-item">
          <div class="report-info">
            <h4>${report.title}</h4>
            <p class="report-date">${report.date}</p>
          </div>
          <a href="/reports/${report.id}/download" class="btn btn-small btn-secondary" target="_blank" rel="noopener noreferrer">Download</a>
        </div>
      `).join('');
  }

  // Render Matched Universities
  function renderMatches() {
    const container = document.getElementById('matchesContainer');
    if (userData.matches.length === 0) {
      container.innerHTML = '<p class="empty-state">No matches available yet. Complete your profile to discover universities.</p>';
      return;
    }
    container.innerHTML = userData.matches.map(uni => {
      const matchClass = uni.matchScore >= 90 ? 'strong-match' : uni.matchScore >= 70 ? 'good-match' : 'moderate-match';
      const isLiked = userData.likes.some(like => String(like.id) === String(uni.id));
      return `
          <div class="match-item ${matchClass}">
            <div class="match-info">
              <h4>${uni.name}</h4>
              <p class="match-program">${uni.programName}</p>
              <p class="match-province">${uni.province}</p>
              <span class="match-score">Match Score: ${uni.matchScore}%</span>
            </div>
            <button class="btn btn-like ${isLiked ? 'liked' : ''}" 
                    onclick="addToLikes('${uni.id}', '${(uni.name + ' - ' + uni.programName).replace(/'/g, "\\'")}', '${uni.province.replace(/'/g, "\\'")}')">
              <span class="heart">${isLiked ? '‚ô•' : '‚ô°'}</span>
            </button>
          </div>
        `;
    }).join('');
  }

  // Render Liked Universities
  function renderLikes() {
    const container = document.getElementById('likesContainer');
    if (userData.likes.length === 0) {
      container.innerHTML = '<p class="empty-state">You haven\'t saved any universities yet.</p>';
      return;
    }
    container.innerHTML = userData.likes.map((uni, index) => `
        <div class="like-item">
          <div class="like-info">
            <h4>${uni.name || 'Saved University'}</h4>
            <p class="like-province">${uni.province || ''}</p>
          </div>
          <button class="btn btn-remove" onclick="removeFromLikes('${uni.id}')">
            ‚úï
          </button>
        </div>
      `).join('');
  }

  // Try to persist a like to server; best-effort. If server responds OK, keep it.
  async function persistLikeToServer(programId) {
    try {
      const res = await fetch('/courses/save_liked_course', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify({ program_id: programId })
      });
      return res.ok;
    } catch (e) {
      console.warn('Could not persist like to server:', e);
      return false;
    }
  }

  async function removeLikeOnServer(programId) {
    try {
      const res = await fetch('/courses/remove_liked_course', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify({ program_id: programId })
      });
      return res.ok;
    } catch (e) {
      console.warn('Could not remove like on server:', e);
      return false;
    }
  }

  // Add or remove likes locally and attempt to sync with server
  async function addToLikes(id, name, province) {
    const alreadyLiked = userData.likes.some((uni) => String(uni.id) === String(id));
    if (!alreadyLiked) {
      const newLike = { id: String(id), name, province, timestamp: new Date().toISOString() };
      userData.likes.push(newLike);
      try { localStorage.setItem('likedCourses', JSON.stringify(userData.likes)); } catch (e) {}
      // Best-effort persist
      const ok = await persistLikeToServer(id);
      if (!ok) {
        // leave local copy (works for unauthenticated/offline users)
      }
    } else {
      userData.likes = userData.likes.filter((uni) => String(uni.id) !== String(id));
      try { localStorage.setItem('likedCourses', JSON.stringify(userData.likes)); } catch (e) {}
      await removeLikeOnServer(id);
    }
    renderLikes();
    renderMatches();
  }

  // Remove from Likes by id
  async function removeFromLikes(id) {
    userData.likes = userData.likes.filter(l => String(l.id) !== String(id));
    try { localStorage.setItem('likedCourses', JSON.stringify(userData.likes)); } catch (e) {}
    await removeLikeOnServer(id);
    renderLikes();
    renderMatches();
  }

  // Fetch saved reports from server and populate dashboard (unchanged behavior)
  (async function loadSavedReports() {
    try {
      const res = await fetch('/api/reports', { credentials: 'same-origin' });
      if (!res.ok) {
        console.warn('Could not fetch reports:', res.status);
        return;
      }
      const data = await res.json();
      if (data && Array.isArray(data.reports)) {
        userData.reports = data.reports.map((r) => ({
          id: r.id || r.report_id || r.reportId || r.report_id,
          title: r.title,
          date: r.created_at || r.createdAt || r.date || '',
        }));
        renderReports();
      }
    } catch (err) {
      console.error('Error loading reports:', err);
    }
  })();
</script>
{% endblock %}
